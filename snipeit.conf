server {
    listen 80;
    server_name _;

    # ---- Snipe-IT root ----
    root /srv/snipe-it/public;
    index index.php index.html;

    # ---- Snipe-IT front controller ----
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

# redirect /appflowy -> /appflowy/
location = /appflowy {
    return 301 /appflowy/;
}

# AppFlowy proxy (strip prefix to upstream, rewrite absolute links back)
location ^~ /appflowy/ {
    # strip prefix for upstream
    rewrite ^/appflowy/(.*)$ /$1 break;

    proxy_pass http://127.0.0.1:18080;   # no trailing slash when using rewrite/break
    proxy_http_version 1.1;
    proxy_set_header Host $host;

    # forwarded headers
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Prefix /appflowy;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;

    # websockets
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_redirect off;

    # allow HTML/CSS/JS rewriting
    proxy_set_header Accept-Encoding "";
    sub_filter_once off;
    sub_filter_types text/html text/css application/javascript application/json;

    # fix base href for root-relative links
    sub_filter '<base href="/"' '<base href="/appflowy/"';

    # fix common SPA public path var (if present in bundle)
    sub_filter 'window.__AF_PUBLIC_PATH__="/"' 'window.__AF_PUBLIC_PATH__="/appflowy/"';

    # rewrite root-absolute attributes
    sub_filter 'href="/'   'href="/appflowy/';
    sub_filter 'src="/'    'src="/appflowy/';
    sub_filter 'action="/' 'action="/appflowy/';
}

    # ---- PHP-FPM for Snipe-IT ----
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # ---- security ----
    location ~ /\.ht {
        deny all;
    }
}
